# =============================================================================
# Madagascar - plots & tables from streamed daily parquet (base R only)
# Produces: yearly disease/workability lines, seasonal timing, risk-day bars,
# and "spells" (consecutive risk days). Opens each PNG after saving.
# =============================================================================


suppressPackageStartupMessages({
  library(arrow)
  library(dplyr)
  library(data.table)
  library(lubridate)
  library(here)
})


# ---- Load helper functions ----
source(here("helpers", "helpers.R"))
source(here("helpers", "plot_helpers.R"))



Sys.setenv("ERA5_STREAM" = "C:/Users/jordan/Desktop/madagascar/stream")
stream_dir <- Sys.getenv("ERA5_STREAM", unset = file.path(out_root, "streamed"))


Sys.setenv("figures_dir" = "C:/Users/jordan/R_Projects/CHI-Data/analysis/madagascar/outputs/figures")
figures_dir <- Sys.getenv("figures_dir")


Sys.setenv("tables_dir" = "C:/Users/jordan/R_Projects/CHI-Data/analysis/madagascar/outputs/tables")
tables_dir <- Sys.getenv("tables_dir")


dir.create(figures_dir)
dir.create(tables_dir)


season_start_month <- 8    # Aug 1 season start (adjustable)
thr_7d             <- 24   # 7-day threshold (hours)
quiet_days         <- 15   # length of quiet window
quiet_max_hours    <- 6    # quiet window allowance
season_start <- 8    # Aug 1 season start (adjustable)


# # ---- 0) Where is your streamed daily data? ----
# stream_dir <- "C:/data/gridded/era5land/madagascar/madagascar_hourly_daily_streamed"
daily_path <- file.path(stream_dir, "daily_agg")  # change to "daily_agg_by_year" if you migrated

# # Output folder for this run
# figures_dir <- file.path(analysis_out_dir, paste0("deliverables_", format(Sys.time(), "%Y%m%d_%H%M")))
# dir.create(figures_dir, showWarnings = FALSE, recursive = TRUE)

# Focus
years_keep   <- 1980:2024
scheme_focus <- "nearest1"   # change to "idw4" to compare

# ---- 1) Read & prep ----
daily_ds <- open_dataset(daily_path, format = "parquet", unify_schemas = TRUE)

daily_all <- daily_ds |>
  mutate(
    year = year(date),
    month = month(date),
    # upcast counts to be safe across mixed partitions
    wbgt28_h = cast(wbgt28_h, float64()),
    wbgt31_h = cast(wbgt31_h, float64()),
    hot35_h  = cast(hot35_h,  float64())
  ) |>
  select(scheme, village, date, year, month,
         tmean_c, tmax_c, tmin_c, dtr_c, rh_mean, vpd_kpa,
         ssrd_MJ_day, wbgt28_h, wbgt31_h, hot35_h,
         work_day_pct, work_night_pct, work_all_pct,
         palm_hours, anth_hours) |>
  collect() |>
  as.data.table()

# Filter scheme/years and drop partial years (<95% days) to avoid end spikes
daily <- daily_all[scheme == scheme_focus & year %in% years_keep]
# 
# daily = daily[village == 'Mandena']
# daily = daily[scheme == scheme_focus & village == 'Mandena']
# daily = unique(daily, by = c("date"))


comp <- daily[, .(frac_ok = mean(is.finite(palm_hours))), by = .(village, year)]
keep_years <- comp[, .(ok = all(frac_ok >= 0.95)), by = year][ok == TRUE, year]
daily <- daily[year %in% keep_years]
setorder(daily, village, date)

# Collapse 2 villages ??? single series (mean across villages)
collapse_by_year <- function(dt, value_col, fun = mean) {
  dt[, .(val = fun(get(value_col), na.rm = TRUE)), by = .(year)
  ][order(year)]
}
collapse_by_month <- function(dt, value_col, fun = mean) {
  dt[, .(val = fun(get(value_col), na.rm = TRUE)), by = .(month)
  ][order(month)]
}

# ---- 2) Season-year timing (Aug???Jul), center-of-mass + 30-day peak ----
season_start_month <- 8L

d2 <- copy(daily)
d2[, `:=`(
  season_year  = ifelse(month >= season_start_month, year, year - 1L),
  season_start = as.IDate(sprintf("%d-%02d-01",
                                  ifelse(month >= season_start_month, year, year - 1L),
                                  season_start_month))
)]

d2[, `:=`(
  season_doy   = as.integer(date - season_start) + 1L
)]


setorder(d2, village, date)
# Rolling sums for Phytophthora
d2[, `:=`(
  palm_7d  = frollsum(palm_hours,  7, align = "right", na.rm = TRUE),
  palm_30d = frollsum(palm_hours, 30, align = "right", na.rm = TRUE)
), by = village]

center_of_mass_doy <- function(doy, w) {
  w[!is.finite(w)] <- 0
  if (sum(w) <= 0) return(NA_integer_)
  maxd <- max(doy, na.rm = TRUE)
  ang  <- 2*pi * (doy - 1) / maxd
  x <- sum(w * cos(ang)); y <- sum(w * sin(ang))
  a <- atan2(y, x); if (a < 0) a <- a + 2*pi
  as.integer(round(a / (2*pi) * maxd)) + 1L
}


# d2$season_doy

seasonal_vil <- d2[, .(
  com_doy  = center_of_mass_doy(season_doy, palm_hours),
  peak30_doy = if (all(is.na(palm_30d))) NA_integer_ else season_doy[which.max(palm_30d)]
), by = .(village, season_year)]

# Collapse villages ??? one value per season_year (mean of DOY)
seasonal <- seasonal_vil[, .(
  com_doy   = mean(com_doy,   na.rm = TRUE),
  peak30_doy = mean(peak30_doy, na.rm = TRUE)
), by = season_year][order(season_year)]

# ---- 3) Risk-days & spells (hours ??? days that matter) ----
riskday_min_hours   <- 4    # ???4 risky hours ??? risk day
sustained_7d_thresh <- 24   # 7-day sum ???24h ??? sustained

daily[, risk_day := palm_hours >= riskday_min_hours]
monthly_risk <- daily[, .(risk_days = mean(sum(risk_day), na.rm = TRUE)),
                      by = .(year, month)][, .(risk_days = mean(risk_days)), by = month]

# Spells: consecutive runs of risk days (collapse villages first)
risks_collapsed <- daily[, .(risk_day = any(risk_day)), by = date][order(date)]
rle_risk <- rle(risks_collapsed$risk_day)
spells <- data.table(len = rle_risk$lengths, risk = rle_risk$values)[risk == TRUE, .N, by = len][order(len)]
fwrite(spells, file.path(tables_dir, "risk_spells_length_counts.csv"))

# 7-day rolling series (collapsed)
roll7 <- risks_collapsed[, .(date, risk_7d = frollsum(as.integer(risk_day), 7, align="right"))]

# ---- 4) Yearly series (collapse villages) ----
yr_palm <- collapse_by_year(daily, "palm_hours", sum)
yr_work_all <- collapse_by_year(daily, "work_day_pct", mean)
mon_work_day <- collapse_by_month(daily, "work_day_pct", mean)




# ---------- Plot helpers ----------
open_file <- function(path) {
  if (requireNamespace("berryFunctions", quietly = TRUE)) {
    berryFunctions::openFile(path)
  } else {
    utils::browseURL(paste0("file:///", normalizePath(path)))
  }
}
set_plot_theme <- function() {
  par(mar = c(5.2, 6.0, 4.6, 1.6),
      mgp = c(3.1, 1.0, 0),
      tcl = -0.35, las = 1,
      cex.axis = 1.25, cex.lab = 1.5, cex.main = 1.8,
      xaxs = "i", yaxs = "i")
}
draw_hgrid <- function(y) abline(h = pretty(y), col = "gray90", lwd = 1)
draw_vgrid <- function(x) abline(v = pretty(x), col = "gray95", lwd = 1)

# # ---- P1) Phytophthora hours per year (averaged across villages) ----
# png1 <- file.path(figures_dir, "P1_palm_hours_yearlines_mean.png")
# png(png1, 1600, 950, res = 150); # set_plot_theme()
# xl <- range(yr_palm$year); yl <- range(pretty(yr_palm$val, 8))
# plot(NA, xlim = xl, ylim = yl, xlab = "Year",
#      ylab = "Phytophthora-favorable hours / year",
#      main = "Phytophthora hours (village mean)")
# draw_hgrid(yl); draw_vgrid(xl)
# lines(yr_palm$year, yr_palm$val, lwd = 3, col = "#444C5C"); points(yr_palm$year, yr_palm$val, pch = 16, cex = 1.1)
# dev.off(); open_file(png1)





yr_palm <- daily[, .(palm_hours = sum(palm_hours, na.rm = TRUE)), 
                 by = .(village, year)][order(village, year)]

cols <- c("Mandena" = "#1b9e77", "Sarahandrano" = "#d95f02")

png1 <- file.path(figures_dir, "P1_palm_hours_yearlines_byvillage.png")
png(png1, 1600, 950, res = 150)
xl <- range(yr_palm$year); yl <- range(pretty(yr_palm$palm_hours, 8))
plot(NA, xlim = xl, ylim = yl, xlab = "Year",
     ylab = "Phytophthora-favorable hours / year",
     main = "Phytophthora hours per village")
draw_hgrid(yl); draw_vgrid(xl)
for (vil in unique(yr_palm$village)) {
  s <- yr_palm[village == vil]
  lines(s$year, s$palm_hours, lwd = 2, col = cols[vil])
  points(s$year, s$palm_hours, pch = 16, col = cols[vil])
}
legend("topleft", bty = "n", lwd = 2, pch = 16, col = cols, legend = names(cols))
dev.off(); open_file(png1)






# 
# yr_work_all <- daily[, .(work_all = mean(work_all_pct, na.rm = TRUE)),
#                      by = .(village, year)][order(village, year)]
# 
# png2 <- file.path(figures_dir, "P2_workability_all_yearlines_byvillage.png")
# png(png2, 1600, 950, res = 150)
# xl <- range(yr_work_all$year); yl <- range(pretty(yr_work_all$work_all, 8))
# plot(NA, xlim = xl, ylim = yl, xlab = "Year",
#      ylab = "Workability (%, all hours)",
#      main = "Workability (all hours) by village")
# draw_hgrid(yl); draw_vgrid(xl)
# for (vil in unique(yr_work_all$village)) {
#   s <- yr_work_all[village == vil]
#   lines(s$year, s$work_all, lwd = 2, col = cols[vil])
#   points(s$year, s$work_all, pch = 16, col = cols[vil])
# }
# legend("bottomleft", bty = "n", lwd = 2, pch = 16, col = cols, legend = names(cols))
# dev.off(); open_file(png2)
# 
# 
# 
# 
# 
# 
# 
# 
# 
# mon_work_day <- daily[, .(work_day = mean(work_day_pct, na.rm = TRUE)),
#                       by = .(village, month)][order(village, month)]
# 
# png3 <- file.path(figures_dir, "P3_workability_monthly_day_byvillage.png")
# png(png3, 1600, 950, res = 150)
# xl <- c(1,12); yl <- range(pretty(mon_work_day$work_day, 8))
# plot(NA, xlim = xl, ylim = yl, xaxt = "n",
#      xlab = "Month", ylab = "Workability (%, 09-16)",
#      main = "Monthly daytime workability by village")
# axis(1, at = 1:12, labels = month.abb, cex.axis = 1.2)
# draw_hgrid(yl); abline(v = 1:12, col = "gray97")
# for (vil in unique(mon_work_day$village)) {
#   s <- mon_work_day[village == vil]
#   lines(s$month, s$work_day, lwd = 2, col = cols[vil])
#   points(s$month, s$work_day, pch = 16, col = cols[vil])
# }
# legend("bottomleft", bty = "n", lwd = 2, pch = 16, col = cols, legend = names(cols))
# dev.off(); open_file(png3)







png4 <- file.path(figures_dir, "P4_season_timing_byvillage.png")
png(png4, 1600, 950, res = 150)
yl <- c(1,365); xl <- range(seasonal_vil$season_year)
plot(NA, xlim = xl, ylim = yl,
     xlab = "Season-year (Aug???Jul)", ylab = "Day of season (DOY)",
     main = "Timing of Phytophthora season by village")
abline(h = seq(0,360,30), col = "gray92"); draw_vgrid(xl)
for (vil in unique(seasonal_vil$village)) {
  s <- seasonal_vil[village == vil]
  points(s$season_year, s$peak30_doy, pch = 16, col = cols[vil])
  points(s$season_year, s$com_doy,   pch = 0,  col = cols[vil])
}
legend("topleft", bty = "n", pch = c(16,0), col = rep(cols, each=2),
       legend = paste(rep(names(cols), each=2), c("Peak30","Center"), sep=" - "))
dev.off(); open_file(png4)


daily[, risk_day := palm_hours >= riskday_min_hours]
monthly_risk <- daily[, .(risk_days = mean(sum(risk_day), na.rm = TRUE)),
                      by =  c('month', 'village')][, .(risk_days = mean(risk_days)), by = c('month', 'village')]

png5 <- file.path(figures_dir, "P5_riskdays_per_month_byvillage.png")
png(png5, 1700, 950, res = 150)
yl <- range(0, max(pretty(monthly_risk$risk_days, 10))+20)
mat <- tapply(monthly_risk$risk_days, list(monthly_risk$village, monthly_risk$month), mean)
barplot(mat, beside = TRUE, ylim = yl, col = cols,
        names.arg = month.abb, ylab = "Risk days per month (avg)",
        main = sprintf("Risk days (???%dh/day) - Phytophthora", riskday_min_hours))
legend("topleft", bty = "n", fill = cols, legend = names(cols))
dev.off(); open_file(png5)
# 
# 
# 
# # ---- P6) Spells (runs of consecutive risky days) ----
# png6 <- file.path(figures_dir, "P6_risk_spells_length_hist.png")
# png(png6, 1500, 950, res = 150); # set_plot_theme()
# barplot(spells$N, names.arg = spells$len, col = "#6B9080", border = "gray40",
#         xlab = "Spell length (consecutive risk days)",
#         ylab = "Count (2000-2022, village-collapsed)",
#         main = "Distribution of risk-day spells")
# abline(h = pretty(range(spells$N)), col = "gray90"); box()
# dev.off(); open_file(png6)
# 



# ---- Save compact CSVs for the figures ----
fwrite(yr_palm,       file.path(tables_dir, "T_yearly_palm_hours_mean.csv"))
fwrite(yr_work_all,   file.path(tables_dir, "T_yearly_workability_all_mean.csv"))
fwrite(mon_work_day,  file.path(tables_dir, "T_monthly_workability_day_clim_mean.csv"))
fwrite(seasonal,      file.path(tables_dir, "T_season_timing_mean.csv"))
fwrite(monthly_risk,  file.path(tables_dir, "T_riskdays_per_month_mean.csv"))

cat("\n??? Wrote plots & tables to:\n", normalizePath(tables_dir), "\n")

























